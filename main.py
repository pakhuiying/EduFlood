import pandas as pd
from flask import Flask, render_template, request
import firebase_admin
from firebase_admin import credentials, firestore, storage
import amisafe

app = Flask(__name__)
# Ensure templates are auto-reloaded


@app.route("/")
def main():
    
    flooded_results = {2: {'flood': True, 'lon': 77.6713031, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689424489733fll.jpg?alt=media&token=dbaa6e33-bf49-4edd-a941-ef6482f76602', 'lat': 12.9858672, 'flood_severity': ''}, 5: {'flood': True, 'lon': 72.808663, 'date': '5 May 2022', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/mumbai2022_2.png?alt=media&token=d86aaaf6-f80d-4cf3-acc1-0c07aa21e56f', 'lat': 19.241286, 'flood_severity': 'low'}, 7: {'flood': True, 'lon': 72.691079, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689421267654fll.jpg?alt=media&token=da78da69-9b2f-49c3-a403-a49e6cd2e1bd', 'lat': 23.2186615, 'flood_severity': ''}, 10: {'lon': 72.6911412, 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689315465417fll.jpg?alt=media&token=fedba13c-95c5-4122-b543-a8a13aac2ea5', 'flood_severiy': 'moderate', 'Date': '30 May 2021', 'lat': 23.2186414, 'flood': True}, 11: {'flood_severity': 'moderate', 'lat': 18.990324, 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/mumbai_1.jpg?alt=media&token=01a9a80f-5d40-481b-a6dd-0f62daa9d65d', 'lon': 72.816559, 'Date': '10 Jul 2021', 'flood': True}, 13: {'flood': True, 'lon': 72.6911452, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689419438104fll.jpg?alt=media&token=9eb5ae1f-ecb4-4cc0-995c-5c09e1000b2f', 'lat': 23.2186404, 'flood_severity': ''}, 14: {'flood': True, 'lon': 72.6911128, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689394961457fll.jpg?alt=media&token=631620a5-9a97-4168-b2b6-5a4478398e05', 'lat': 23.2186487, 'flood_severity': ''}, 15: {'flood_severity': 'moderate', 'lat': 19.060366, 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/mumbai_3.png?alt=media&token=c9d65b52-a653-4604-bfc1-e21a491ead8d', 'lon': 72.830223, 'date': '26 Jul 2005', 'flood': True}, 16: {'flood': True, 'lon': 72.691112, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689415862174fll.jpg?alt=media&token=42ea0b09-4f32-45da-9309-7c86d772a038', 'lat': 23.2186498, 'flood_severity': ''}, 19: {'flood': True, 'lon': 77.6713031, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689406361384fll.jpg?alt=media&token=612a263c-f799-43dd-aa4d-d896227e6974', 'lat': 12.9858672, 'flood_severity': ''}, 20: {'flood': True, 'lon': 72.894163, 'date': '25 Aug 2021', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/mumbai2022_2.png?alt=media&token=d86aaaf6-f80d-4cf3-acc1-0c07aa21e56f', 'lat': 19.101755, 'flood_severity': 'low'}, 21: {'flood': True, 'lon': 72.6911195, 'date': '14 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689351541200fll.jpg?alt=media&token=6ff46431-b2bf-4023-9399-e18c0cb9c3f4', 'lat': 23.2186499, 'flood_severity': ''}, 24: {'flood': True, 'lon': 77.6713031, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689388437245fll.jpg?alt=media&token=a73fc467-b9a8-460b-9326-884a104ae9d8', 'lat': 12.9858672, 'flood_severity': ''}, 30: {'flood': True, 'lon': 72.6910753, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689416617958fll.jpg?alt=media&token=ad319ace-e828-46cb-83c1-435573bfcaf5', 'lat': 23.2186638, 'flood_severity': ''}, 31: {'lat': 18.922305, 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/mumbai2022_1.png?alt=media&token=c579aef9-ab84-49ab-af14-916154cc77c7', 'lon': 72.827703, 'date': '12 Aug 2022', 'flood_severity ': 'moderate', 'flood': True}, 32: {'flood': True, 'lon': 72.6911076, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689419520506fll.jpg?alt=media&token=22b7c69b-b700-47fa-a521-79f3264db7d4', 'lat': 23.2186516, 'flood_severity': ''}, 34: {'flood_severity': 'low', 'lat': 19.083728, 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/mumbai_2.jpg?alt=media&token=f1e558df-a34d-4a25-83f7-a7726882ef74', 'lon': 72.86895, 'date': '26 Jul 2005', 'flood': True}, 35: {'flood': True, 'lon': 72.6911452, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689419379842fll.jpg?alt=media&token=e624ca45-f4cc-4aec-94c5-40b1bd8c24dc', 'lat': 23.2186404, 'flood_severity': ''}, 36: {'flood': True, 'lon': 77.6713031, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689416744535fll.jpg?alt=media&token=232b175d-655f-49c6-994c-70e4d8204085', 'lat': 12.9858672, 'flood_severity': ''}, 39: {'lon': 72.865305, 'date': '1 Jul 2022', 'lat': 19.013644, 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/mumbai2022_3.png?alt=media&token=9205e819-ab11-4eae-8050-105ba8c6cf6f', 'flood_severity ': 'high', 'flood': True}, 40: {'flood': True, 'lon': 72.6910753, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689416674667fll.jpg?alt=media&token=f2535d83-d298-45d7-ba7a-6e180f849f62', 'lat': 23.2186638, 'flood_severity': ''}, 43: {'flood_severity': 'moderate', 'lon': 77.6713031, 'date': '14 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689329993507fll.jpg?alt=media&token=8001adec-abb3-48db-a9de-892aae707167', 'lat': 12.9858672, 'flood': True}, 50: {'flood': True, 'lon': 78.3728344, 'date': '21 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689916944674fll%20-%20Copy.jpg?alt=media&token=2b04a7a1-106d-43f0-bb28-db90123fc993', 'lat': 17.433028, 'flood_severity': ''}, 53: {'flood': True, 'lon': 72.847547, 'date': '7 Jun 2022', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/mumbai2022_3.png?alt=media&token=9205e819-ab11-4eae-8050-105ba8c6cf6f', 'lat': 19.117632, 'flood_severity': 'high'}, 56: {'flood': True, 'lon': 77.6713031, 'date': 1689328467503, 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689328467503fll.jpg?alt=media&token=b1bcc9bf-f153-40e1-bf54-1bf4175283bc', 'lat': 12.9858672, 'flood_severity': ''}, 57: {'flood': True, 'lon': 77.6713031, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689424723913fll%20-%20Copy.jpg?alt=media&token=081636e2-b943-4c8b-854d-331156f16c45', 'lat': 12.9858672, 'flood_severity': ''}, 58: {'flood': True, 'lon': 77.6713031, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689427498685fll%20-%20Copy.jpg?alt=media&token=fe358732-05f1-4e3d-a50d-1004f160e033', 'lat': 12.9858672, 'flood_severity': ''}, 60: {'flood_severity': 'moderate', 'lon': 72.6910753, 'date': 1689328755739, 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689328755739fll.jpg?alt=media&token=9d54d4b3-8a9d-4fd5-9814-bd792ed62393', 'lat': 23.2186638, 'flood': True}, 61: {'flood_severity': 'moderate', 'lon': 72.6910819, 'date': '14 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689331332956fll.jpg?alt=media&token=2e485bbf-e0b7-497d-ae8b-d6d888dc3561', 'lat': 23.2186553, 'flood': True}, 62: {'flood': True, 'lon': 72.6911507, 'date': '14 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689330056759fll.jpg?alt=media&token=b9674b7e-be2d-418c-b22b-f5a3017d8e1f', 'lat': 23.2186375, 'flood_severity': 'moderate'}, 66: {'flood': True, 'lon': 77.6713031, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689425266530fll%20-%20Copy.jpg?alt=media&token=d2db777d-7ca0-4a51-bc75-2b7efc9ea844', 'lat': 12.9858672, 'flood_severity': ''}}

    df = pd.read_csv('https://gist.githubusercontent.com/mickeykedia/9d9144072c5f637c26995569dd347614/raw/b65134846607235adf4ad6498713deed77d3b4b5/ward_level_collated.csv')
    df_cropped = df.loc[:,['Ward_Alphabet','Ward_Names','TOT_P_DEN']].set_index(['Ward_Alphabet'])
    mumbai_dict = df_cropped.to_dict('index')

    return render_template("my_map.html",flooded_results = flooded_results, mumbai_dict=mumbai_dict)


@app.route("/amisafe", methods=["POST"])
def am_i_safe():
    coord = request.form.get("coord")
    print(f'coord: {coord}')
    lat, lon = coord.split(',')
    lat, lon = float(lat.strip()), float(lon.strip())
    ais = amisafe.AmISafe(lat_deg=lat,lon_deg=lon,zoom=15)
    itsxn_dict = ais.check_intersection(e1 = 1, e2 = 2,r1_meters = 50, r2_meters = 100, plot = False)
    print(f'itersection: {itsxn_dict}')

    flooded_results = {2: {'flood': True, 'lon': 77.6713031, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689424489733fll.jpg?alt=media&token=dbaa6e33-bf49-4edd-a941-ef6482f76602', 'lat': 12.9858672, 'flood_severity': ''}, 5: {'flood': True, 'lon': 72.808663, 'date': '5 May 2022', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/mumbai2022_2.png?alt=media&token=d86aaaf6-f80d-4cf3-acc1-0c07aa21e56f', 'lat': 19.241286, 'flood_severity': 'low'}, 7: {'flood': True, 'lon': 72.691079, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689421267654fll.jpg?alt=media&token=da78da69-9b2f-49c3-a403-a49e6cd2e1bd', 'lat': 23.2186615, 'flood_severity': ''}, 10: {'lon': 72.6911412, 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689315465417fll.jpg?alt=media&token=fedba13c-95c5-4122-b543-a8a13aac2ea5', 'flood_severiy': 'moderate', 'Date': '30 May 2021', 'lat': 23.2186414, 'flood': True}, 11: {'flood_severity': 'moderate', 'lat': 18.990324, 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/mumbai_1.jpg?alt=media&token=01a9a80f-5d40-481b-a6dd-0f62daa9d65d', 'lon': 72.816559, 'Date': '10 Jul 2021', 'flood': True}, 13: {'flood': True, 'lon': 72.6911452, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689419438104fll.jpg?alt=media&token=9eb5ae1f-ecb4-4cc0-995c-5c09e1000b2f', 'lat': 23.2186404, 'flood_severity': ''}, 14: {'flood': True, 'lon': 72.6911128, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689394961457fll.jpg?alt=media&token=631620a5-9a97-4168-b2b6-5a4478398e05', 'lat': 23.2186487, 'flood_severity': ''}, 15: {'flood_severity': 'moderate', 'lat': 19.060366, 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/mumbai_3.png?alt=media&token=c9d65b52-a653-4604-bfc1-e21a491ead8d', 'lon': 72.830223, 'date': '26 Jul 2005', 'flood': True}, 16: {'flood': True, 'lon': 72.691112, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689415862174fll.jpg?alt=media&token=42ea0b09-4f32-45da-9309-7c86d772a038', 'lat': 23.2186498, 'flood_severity': ''}, 19: {'flood': True, 'lon': 77.6713031, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689406361384fll.jpg?alt=media&token=612a263c-f799-43dd-aa4d-d896227e6974', 'lat': 12.9858672, 'flood_severity': ''}, 20: {'flood': True, 'lon': 72.894163, 'date': '25 Aug 2021', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/mumbai2022_2.png?alt=media&token=d86aaaf6-f80d-4cf3-acc1-0c07aa21e56f', 'lat': 19.101755, 'flood_severity': 'low'}, 21: {'flood': True, 'lon': 72.6911195, 'date': '14 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689351541200fll.jpg?alt=media&token=6ff46431-b2bf-4023-9399-e18c0cb9c3f4', 'lat': 23.2186499, 'flood_severity': ''}, 24: {'flood': True, 'lon': 77.6713031, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689388437245fll.jpg?alt=media&token=a73fc467-b9a8-460b-9326-884a104ae9d8', 'lat': 12.9858672, 'flood_severity': ''}, 30: {'flood': True, 'lon': 72.6910753, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689416617958fll.jpg?alt=media&token=ad319ace-e828-46cb-83c1-435573bfcaf5', 'lat': 23.2186638, 'flood_severity': ''}, 31: {'lat': 18.922305, 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/mumbai2022_1.png?alt=media&token=c579aef9-ab84-49ab-af14-916154cc77c7', 'lon': 72.827703, 'date': '12 Aug 2022', 'flood_severity ': 'moderate', 'flood': True}, 32: {'flood': True, 'lon': 72.6911076, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689419520506fll.jpg?alt=media&token=22b7c69b-b700-47fa-a521-79f3264db7d4', 'lat': 23.2186516, 'flood_severity': ''}, 34: {'flood_severity': 'low', 'lat': 19.083728, 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/mumbai_2.jpg?alt=media&token=f1e558df-a34d-4a25-83f7-a7726882ef74', 'lon': 72.86895, 'date': '26 Jul 2005', 'flood': True}, 35: {'flood': True, 'lon': 72.6911452, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689419379842fll.jpg?alt=media&token=e624ca45-f4cc-4aec-94c5-40b1bd8c24dc', 'lat': 23.2186404, 'flood_severity': ''}, 36: {'flood': True, 'lon': 77.6713031, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689416744535fll.jpg?alt=media&token=232b175d-655f-49c6-994c-70e4d8204085', 'lat': 12.9858672, 'flood_severity': ''}, 39: {'lon': 72.865305, 'date': '1 Jul 2022', 'lat': 19.013644, 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/mumbai2022_3.png?alt=media&token=9205e819-ab11-4eae-8050-105ba8c6cf6f', 'flood_severity ': 'high', 'flood': True}, 40: {'flood': True, 'lon': 72.6910753, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689416674667fll.jpg?alt=media&token=f2535d83-d298-45d7-ba7a-6e180f849f62', 'lat': 23.2186638, 'flood_severity': ''}, 43: {'flood_severity': 'moderate', 'lon': 77.6713031, 'date': '14 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689329993507fll.jpg?alt=media&token=8001adec-abb3-48db-a9de-892aae707167', 'lat': 12.9858672, 'flood': True}, 50: {'flood': True, 'lon': 78.3728344, 'date': '21 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689916944674fll%20-%20Copy.jpg?alt=media&token=2b04a7a1-106d-43f0-bb28-db90123fc993', 'lat': 17.433028, 'flood_severity': ''}, 53: {'flood': True, 'lon': 72.847547, 'date': '7 Jun 2022', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/mumbai2022_3.png?alt=media&token=9205e819-ab11-4eae-8050-105ba8c6cf6f', 'lat': 19.117632, 'flood_severity': 'high'}, 56: {'flood': True, 'lon': 77.6713031, 'date': 1689328467503, 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689328467503fll.jpg?alt=media&token=b1bcc9bf-f153-40e1-bf54-1bf4175283bc', 'lat': 12.9858672, 'flood_severity': ''}, 57: {'flood': True, 'lon': 77.6713031, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689424723913fll%20-%20Copy.jpg?alt=media&token=081636e2-b943-4c8b-854d-331156f16c45', 'lat': 12.9858672, 'flood_severity': ''}, 58: {'flood': True, 'lon': 77.6713031, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689427498685fll%20-%20Copy.jpg?alt=media&token=fe358732-05f1-4e3d-a50d-1004f160e033', 'lat': 12.9858672, 'flood_severity': ''}, 60: {'flood_severity': 'moderate', 'lon': 72.6910753, 'date': 1689328755739, 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689328755739fll.jpg?alt=media&token=9d54d4b3-8a9d-4fd5-9814-bd792ed62393', 'lat': 23.2186638, 'flood': True}, 61: {'flood_severity': 'moderate', 'lon': 72.6910819, 'date': '14 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689331332956fll.jpg?alt=media&token=2e485bbf-e0b7-497d-ae8b-d6d888dc3561', 'lat': 23.2186553, 'flood': True}, 62: {'flood': True, 'lon': 72.6911507, 'date': '14 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689330056759fll.jpg?alt=media&token=b9674b7e-be2d-418c-b22b-f5a3017d8e1f', 'lat': 23.2186375, 'flood_severity': 'moderate'}, 66: {'flood': True, 'lon': 77.6713031, 'date': '15 Jul 2023', 'image': 'https://firebasestorage.googleapis.com/v0/b/floodbase-15dfb.appspot.com/o/1689425266530fll%20-%20Copy.jpg?alt=media&token=d2db777d-7ca0-4a51-bc75-2b7efc9ea844', 'lat': 12.9858672, 'flood_severity': ''}}

    return render_template("amisafe.html", lat=lat, lon=lon, itsxn_dict=itsxn_dict,flooded_results = flooded_results)

if __name__ == "__main__":
    # for r in result:
    #     print(r.to_dict())
    app.jinja_env.auto_reload = True
    app.config["TEMPLATES_AUTO_RELOAD"] = True
    app.run(debug=False)

    # app.run(port=1111)
